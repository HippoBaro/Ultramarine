# Based on seastar/.travis.yml (https://github.com/scylladb/seastar/blob/master/.travis.yml)

dist: trusty
sudo: required
language: cpp
compiler: gcc
dependencies:
  &seastar_deps [
    "libaio-dev",
    "ninja-build",
    "ragel",
    "libhwloc-dev",
    "libnuma-dev",
    "libpciaccess-dev",
    "libcrypto++-dev",
    "scylla-libboost165-all-dev",
    "libxml2-dev",
    "xfslibs-dev",
    "libgnutls28-dev",
    "liblz4-dev",
    "libsctp-dev",
    "make",
    "libprotobuf-dev",
    "protobuf-compiler",
    "python3",
    "systemtap-sdt-dev",
    "libtool",
    "libyaml-cpp-dev"
  ]
matrix:
  include:
  # GCC 7, DPDK enabled
  - env: DPDK_MODE="ON" COMPILER="g++-7" C_COMPILER="gcc-7"
    addons: &gcc7
      apt:
        sources:
        - ubuntu-toolchain-r-test
        - sourceline: 'deb http://ppa.launchpad.net/scylladb/ppa/ubuntu trusty main'
          key_url: 'https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x6B2BFD3660EF3F5B'
        packages:
        - *seastar_deps
        - g++-7
  # GCC 7, DPDK disabled
  - env: DPDK_MODE="OFF" COMPILER="g++-7" C_COMPILER="gcc-7"
    addons: *gcc7
  # Clang 5.0, DPDK disabled
  # Suppress unused lambda capture warning due to a Clang bug (see https://reviews.llvm.org/rL296602)
  # Suppress missing braces warning due to a Clang bug (see https://bugs.llvm.org/show_bug.cgi?id=21629)
  # Need g++-7 to bring up-to-date libstdc++ in
  - env: DPDK_MODE="OFF" COMPILER="clang++-7" C_COMPILER="clang-7" CFLAGS="-Wno-unused-lambda-capture -Wno-missing-braces"
    compiler: clang
    addons: &clang7
      apt:
        sources:
        - ubuntu-toolchain-r-test
        - llvm-toolchain-trusty-7
        - sourceline: 'deb http://ppa.launchpad.net/scylladb/ppa/ubuntu trusty main'
          key_url: 'https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x6B2BFD3660EF3F5B'
        packages:
        - *seastar_deps
        - clang-7
        - g++-7

install:
- wget "https://cmake.org/files/v3.12/cmake-3.12.3-Linux-x86_64.sh"
- chmod +x cmake-3.12.3-Linux-x86_64.sh
- sudo ./cmake-3.12.3-Linux-x86_64.sh --skip-license --exclude-subdir --prefix=/usr/local

before_script:
- mkdir build && cd build
- LDFLAGS="-L/opt/scylladb/lib/x86_64-linux-gnu/" /usr/local/bin/cmake -DCMAKE_BUILD_TYPE=Release -DSEASTAR_ENABLE_DPDK=${DPDK_MODE} -DCMAKE_CXX_COMPILER=${COMPILER} -DCMAKE_C_COMPILER=${C_COMPILER} -DCMAKE_CXX_FLAGS="-I/opt/scylladb/include/ $CFLAGS" -DBOOST_INCLUDEDIR="/opt/scylladb/include" -DBOOST_LIBRARYDIR="/opt/scylladb/lib/x86_64-linux-gnu/" -GNinja ..

script:
- ninja -j`nproc --all`
- ninja tests -j`nproc --all`
- ctest .
